<!-- <!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="./libs/mindar/mindar-image-three.prod.js"></script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
          "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
        }
      }
    </script>

    <script type="module" src="./main.js"></script>
  </head>
  <style>
    html,
    body {
      position: relative;
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
  </style>
  <body></body>
</html> -->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebXR Hit Test (Follow Reticle)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-gesture-detector@3.0.4/dist/aframe-gesture-detector.min.js"></script>
    <script>
      AFRAME.registerComponent("ar-hit-test", {
        init: function () {
          const scene = this.el.sceneEl;

          this.reticle = document.createElement("a-entity");
          this.reticle.setAttribute(
            "geometry",
            "primitive: ring; radiusInner: 0.04; radiusOuter: 0.05;"
          );
          this.reticle.setAttribute(
            "material",
            "color: yellow; shader: flat; opacity: 0.8;"
          );
          this.reticle.setAttribute("rotation", "-90 0 0");
          this.reticle.setAttribute("visible", "false");
          scene.appendChild(this.reticle);

          this.model = document.createElement("a-entity");
          this.model.setAttribute(
            "gltf-model",
            "https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF/Duck.gltf"
          );
          this.model.setAttribute("scale", "0.3 0.3 0.3");
          this.model.setAttribute("gesture-handler", "");
          this.model.setAttribute("visible", "false");
          scene.appendChild(this.model);

          this.locked = false;
          scene.addEventListener("onefingermove", () => (this.locked = true));
          scene.addEventListener("twofingermove", () => (this.locked = true));

          this.hitTestSource = null;
          this.viewerSpace = null;
          this.refSpace = null;

          scene.renderer.xr.addEventListener("sessionstart", (ev) => {
            const session = scene.renderer.xr.getSession();
            session.requestReferenceSpace("viewer").then((space) => {
              this.viewerSpace = space;
              session.requestHitTestSource({ space }).then((source) => {
                this.hitTestSource = source;
              });
            });
            session.requestReferenceSpace("local").then((space) => {
              this.refSpace = space;
            });
          });
        },

        tick: function () {
          const frame = this.el.sceneEl.frame;
          if (!frame || !this.hitTestSource || !this.refSpace) return;

          if (this.locked) return; // stop following once locked

          const hitTestResults = frame.getHitTestResults(this.hitTestSource);
          if (hitTestResults.length > 0) {
            const pose = hitTestResults[0].getPose(this.refSpace);

            this.reticle.object3D.visible = true;
            this.reticle.object3D.position.copy(pose.transform.position);
            this.reticle.object3D.quaternion.copy(pose.transform.orientation);

            this.model.object3D.visible = true;
            this.model.object3D.position.copy(this.reticle.object3D.position);
            this.model.object3D.quaternion.copy(
              this.reticle.object3D.quaternion
            );
          }
        },
      });

      // Move + rotate gestures
      AFRAME.registerComponent("gesture-handler", {
        init: function () {
          const el = this.el;
          this.rotation = { y: 0 };

          el.sceneEl.addEventListener("onefingerstart", (e) => {
            this.startPosition = e.detail.position;
          });

          el.sceneEl.addEventListener("onefingermove", (e) => {
            if (!this.startPosition) return;
            const delta = e.detail.positionChange;
            el.object3D.position.x += delta.x / 100;
            el.object3D.position.z += delta.y / 100;
          });

          el.sceneEl.addEventListener("twofingermove", (e) => {
            this.rotation.y += e.detail.positionChange.x * 0.5;
            el.object3D.rotation.y = THREE.MathUtils.degToRad(this.rotation.y);
          });
        },
      });
    </script>
  </head>
  <body>
    <a-scene
      webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #overlay"
      xr-mode-ui="enabled: true"
      ar-hit-test
      gesture-detector
      renderer="colorManagement: true; physicallyCorrectLights: true"
    >
      <a-camera></a-camera>
    </a-scene>
    <div id="overlay">
      <p style="position: absolute; top: 10px; left: 10px; color: white">
        Move phone to detect a surface. Drag/rotate once to place model.
      </p>
    </div>
  </body>
</html>
